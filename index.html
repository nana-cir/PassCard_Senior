<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>かんたんパスワード管理 v2</title>
<style>
    /* --- 基本デザイン（見やすさ優先） --- */
    body { font-family: sans-serif; background-color: #f0f4f8; color: #111; margin: 0; padding: 15px; }
    h2 { color: #0056b3; border-bottom: 2px solid #0056b3; }
    .card { background: #fff; border: 2px solid #ccc; border-radius: 12px; padding: 20px; margin-bottom: 30px; }
    
    label { display: block; font-weight: bold; margin-bottom: 5px; background: #e6f2ff; padding: 5px; border-left: 5px solid #0056b3; }
    input, select { width: 100%; padding: 15px; font-size: 1.2em; border: 2px solid #888; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
    
    button { width: 100%; padding: 15px; font-size: 1.2em; border: none; border-radius: 10px; color: white; margin-bottom: 15px; cursor: pointer; }
    .btn-main { background-color: #007bff; }
    .btn-sub { background-color: #6c757d; }
    .btn-alert { background-color: #d9534f; margin-top: 20px; }

    /* ロック画面用 */
    #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f4f8; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;}
    .lock-box { background: white; padding: 20px; border-radius: 10px; width: 100%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }

    /* リスト用 */
    .item-card { background: #fff; border: 2px solid #aaa; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .data-row { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; font-size: 1.2em; display: flex; justify-content: space-between; align-items: center; overflow: hidden;}
    
    @media print { .no-print { display: none; } .card { border: none; } }
</style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2 style="margin-top:0;">パスワード管理帳</h2>
        
        <div id="setup-mode" style="display:none;">
            <p>最初に「カギ」を決めましょう</p>
            <input type="number" id="new-pin" placeholder="数字4ケタ (例: 1234)" style="text-align:center;">
            
            <p style="text-align:left; font-size:0.9em; margin-top:20px;">
                <strong>※重要：忘れた時のための「秘密の質問」</strong><br>
                昔から変わらないことを登録してください。
            </p>
            <select id="secret-q">
                <option value="mom">母親の旧姓は？</option>
                <option value="school">通っていた小学校の名前は？</option>
                <option value="food">一番好きな食べ物は？</option>
                <option value="pet">初めて飼ったペットの名前は？</option>
            </select>
            <input type="text" id="secret-a" placeholder="答え（ひらがな推奨）">

            <button onclick="setupApp()" class="btn-main">これで始める</button>
        </div>

        <div id="unlock-mode" style="display:none;">
            <p>カギ（数字4ケタ）を入れてください</p>
            <input type="number" id="input-pin" placeholder="****" style="text-align:center;">
            <button onclick="unlockApp()" class="btn-main">開く</button>
            
            <p style="margin-top:20px; color:#d9534f; text-decoration:underline; cursor:pointer;" onclick="showRecovery()">
                カギを忘れましたか？
            </p>
        </div>

        <div id="recovery-mode" style="display:none;">
            <h3 style="color:#d9534f;">カギの再発行</h3>
            <p id="recovery-q-text" style="font-weight:bold;">質問</p>
            <input type="text" id="recovery-a" placeholder="答えを入力">
            <button onclick="checkRecovery()" class="btn-alert">カギを再設定する</button>
            <button onclick="location.reload()" class="btn-sub">戻る</button>
        </div>
    </div>
</div>

<div id="app-screen" style="display:none;">
    <div class="card no-print">
        <h2>新規登録</h2>
        <label>サービス名</label>
        <input type="text" id="s-name" placeholder="例：ドコモ、銀行">
        <label>ID / 番号</label>
        <input type="text" id="s-id">
        <label>パスワード</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="s-pass">
            <button onclick="makePass()" style="width:100px; padding:5px; margin:0; font-size:1em;">自動作成</button>
        </div>
        <label>もしもの時の対応</label>
        <select id="s-act">
            <option>家族に任せる</option>
            <option>すぐに解約してください</option>
            <option>中身を確認してください</option>
        </select>
        <button onclick="addCard()" class="btn-main">保存する</button>
    </div>

    <div class="card no-print" style="background:#e8f5e9; border-color:#28a745;">
        <h2>家族へ渡す準備</h2>
        <p>印刷するか、PDFで保存できます。</p>
        <button onclick="window.print()" class="btn-sub" style="background:#28a745;">家族共有シートを作る</button>
    </div>

    <h2>登録リスト</h2>
    <div id="list"></div>
</div>

<script>
    // --- 起動処理 ---
    const KEY_PIN = 'passSenior_PIN';
    const KEY_Q = 'passSenior_Q';
    const KEY_A = 'passSenior_A';
    const KEY_DATA = 'passSenior_Data';

    checkState();

    function checkState() {
        const pin = localStorage.getItem(KEY_PIN);
        if (!pin) {
            document.getElementById('setup-mode').style.display = 'block';
        } else {
            document.getElementById('unlock-mode').style.display = 'block';
        }
    }

    // --- セットアップ ---
    function setupApp() {
        const pin = document.getElementById('new-pin').value;
        const q = document.getElementById('secret-q').value;
        const a = document.getElementById('secret-a').value;

        if(pin.length !== 4) { alert("カギは数字4ケタにしてください"); return; }
        if(!a) { alert("秘密の質問の答えを入れてください"); return; }

        localStorage.setItem(KEY_PIN, pin);
        localStorage.setItem(KEY_Q, q);
        localStorage.setItem(KEY_A, a);

        alert("設定しました！\n忘れないようにしてください。");
        location.reload();
    }

    // --- ロック解除 ---
    function unlockApp() {
        const input = document.getElementById('input-pin').value;
        const correct = localStorage.getItem(KEY_PIN);
        if(input === correct) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            renderList();
        } else {
            alert("カギが違います");
        }
    }

    // --- 救済モード ---
    function showRecovery() {
        document.getElementById('unlock-mode').style.display = 'none';
        document.getElementById('recovery-mode').style.display = 'block';
        
        // 質問文の表示変換
        const qKey = localStorage.getItem(KEY_Q);
        const qMap = {
            "mom": "母親の旧姓は？",
            "school": "通っていた小学校の名前は？",
            "food": "一番好きな食べ物は？",
            "pet": "初めて飼ったペットの名前は？"
        };
        document.getElementById('recovery-q-text').innerText = qMap[qKey];
    }

    function checkRecovery() {
        const inputA = document.getElementById('recovery-a').value;
        const correctA = localStorage.getItem(KEY_A);

        if(inputA === correctA) {
            alert("正解です！\n新しいカギを設定してください。");
            // データは消さずに、PINだけ消してセットアップへ戻す
            localStorage.removeItem(KEY_PIN);
            location.reload();
        } else {
            alert("答えが違います...");
        }
    }

    // --- アプリ機能 (簡易版) ---
    function makePass() {
        const c = "abcdefghijkmnpqrstuvwxyz23456789";
        let p = "";
        for(i=0;i<8;i++) p+=c[Math.floor(Math.random()*c.length)];
        document.getElementById('s-pass').value = p;
    }

    function addCard() {
        const name = document.getElementById('s-name').value;
        const id = document.getElementById('s-id').value;
        const pass = document.getElementById('s-pass').value;
        const act = document.getElementById('s-act').value;
        if(!name || !pass) return;

        const list = JSON.parse(localStorage.getItem(KEY_DATA)) || [];
        list.push({name, id, pass, act});
        localStorage.setItem(KEY_DATA, JSON.stringify(list));
        
        document.getElementById('s-name').value = "";
        document.getElementById('s-id').value = "";
        document.getElementById('s-pass').value = "";
        renderList();
        alert("保存しました");
    }

    function renderList() {
        const list = JSON.parse(localStorage.getItem(KEY_DATA)) || [];
        const div = document.getElementById('list');
        div.innerHTML = "";
        list.forEach((item, idx) => {
            div.innerHTML += `
            <div class="item-card">
                <div style="font-weight:bold; color:#0056b3; margin-bottom:5px;">${item.name}</div>
                <div style="font-size:0.9em; color:#d9534f;">もしも：${item.act}</div>
                <div class="data-row">ID: ${item.id}</div>
                <div class="data-row">PASS: ${item.pass}</div>
                <div class="no-print" style="text-align:right; margin-top:5px;">
                    <button onclick="delCard(${idx})" style="width:auto; padding:5px 10px; font-size:1em; background:#d9534f; margin:0;">削除</button>
                </div>
            </div>`;
        });
    }

    function delCard(idx) {
        if(confirm("削除しますか？")) {
            const list = JSON.parse(localStorage.getItem(KEY_DATA)) || [];
            list.splice(idx, 1);
            localStorage.setItem(KEY_DATA, JSON.stringify(list));
            renderList();
        }
    }
</script>

</body>
</html>
